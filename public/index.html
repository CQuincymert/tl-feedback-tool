<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>360° Feedback</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      background: #f4f4f5;
      margin: 0;
      padding: 2rem 1rem;
      color: #0f172a;
    }
    .shell {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border-radius: 14px;
      padding: 1.8rem 2.2rem;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
    }
    h1 { margin: 0 0 0.5rem 0; }
    h2 { margin-top: 1.4rem; }
    .muted { color:#64748b; font-size:0.95rem; }
    .card {
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:1rem 1.1rem;
      background:#f9fafb;
      margin-top: 1rem;
    }
    .row { display:flex; gap:0.8rem; flex-wrap:wrap; align-items:center; }
    input[type="text"], textarea {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 10px;
      border: 1px solid #d4d4d8;
      font-size: 1rem;
      background: #fff;
      box-sizing: border-box;
    }
    textarea { min-height: 90px; resize: vertical; }
    button {
      padding: 0.55rem 0.9rem;
      border-radius: 10px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }
    button.secondary { background:#e5e7eb; color:#111827; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .err {
      margin-top: 0.6rem;
      color:#b91c1c;
      background:#fef2f2;
      border:1px solid #fecaca;
      padding:0.7rem 0.8rem;
      border-radius: 10px;
      display:none;
    }
    .ok {
      margin-top: 0.6rem;
      color:#065f46;
      background:#ecfdf5;
      border:1px solid #a7f3d0;
      padding:0.7rem 0.8rem;
      border-radius: 10px;
      display:none;
    }

    .section-title {
      margin: 1.2rem 0 0.4rem 0;
      font-weight: 700;
      font-size: 1.05rem;
      color:#0f172a;
    }

    .q {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 0.9rem 1rem;
      margin-top: 0.8rem;
      background:#fff;
    }
    .q label.title {
      display:block;
      font-weight: 600;
      margin-bottom: 0.65rem;
    }
    .radios {
      display:flex;
      gap: 0.8rem;
      flex-wrap:wrap;
    }
    .radios label {
      display:flex;
      align-items:center;
      gap:0.35rem;
      border:1px solid #e5e7eb;
      border-radius: 999px;
      padding:0.35rem 0.6rem;
      background:#f9fafb;
      cursor:pointer;
    }
    .footer-actions {
      margin-top: 1.4rem;
      display:flex;
      gap:0.7rem;
      align-items:center;
      flex-wrap:wrap;
    }
    .tiny { font-size:0.88rem; color:#64748b; }
  </style>
</head>
<body>
  <div class="shell">
    <h1>360° Team Leader Feedback</h1>
    <p class="muted">
      This feedback is anonymous. Your responses will be combined into a summary report.
      Please focus on observable behaviours and keep comments constructive.
    </p>

    <!-- STEP 1: ENTER CODE -->
    <div id="step1" class="card">
      <h2 style="margin:0 0 0.4rem 0;">Enter your feedback code</h2>
      <p class="muted" style="margin:0 0 0.8rem 0;">
        Enter the one-time code you were given to start the questionnaire.
      </p>

      <div class="row">
        <div style="flex:1; min-width: 240px;">
          <input type="text" id="codeInput" placeholder="e.g. ABCD-1234" autocomplete="off" />
        </div>
        <button id="startBtn">Start</button>
      </div>

      <div id="step1Err" class="err"></div>
      <div id="step1Ok" class="ok"></div>
      <p class="tiny" style="margin-top:0.8rem;">
        Tip: once you submit, this code cannot be reused.
      </p>
    </div>

    <!-- STEP 2: QUESTIONS -->
    <form id="step2" class="card" style="display:none;">
      <h2 style="margin:0 0 0.4rem 0;">Questionnaire</h2>
      <p class="muted" style="margin:0 0 0.8rem 0;">
        All questions are required.
      </p>

      <div class="section-title">Leadership and Management</div>
      <div id="q2" class="q"></div>
      <div id="q3" class="q"></div>
      <div id="q4" class="q"></div>

      <div class="section-title">Communication</div>
      <div id="q5" class="q"></div>
      <div id="q6" class="q"></div>
      <div id="q7" class="q"></div>

      <div class="section-title">Team Support and Development</div>
      <div id="q8" class="q"></div>
      <div id="q9" class="q"></div>
      <div id="q10" class="q"></div>

      <div class="section-title">Collaboration and Culture</div>
      <div id="q11" class="q"></div>
      <div id="q12" class="q"></div>
      <div id="q13" class="q"></div>

      <div class="section-title">Execution and Accountability</div>
      <div id="q14" class="q"></div>
      <div id="q15" class="q"></div>
      <div id="q16" class="q"></div>

      <div class="section-title">Open-ended questions</div>

      <div class="q">
        <label class="title" for="strengthsText">What are this team leader’s greatest strengths?</label>
        <textarea id="strengthsText" required></textarea>
      </div>

      <div class="q">
        <label class="title" for="devText">What could this team leader improve or develop further?</label>
        <textarea id="devText" required></textarea>
      </div>

      <div class="q">
        <label class="title" for="otherText">Is there anything else you would like to share that would help this leader succeed?</label>
        <textarea id="otherText" required></textarea>
      </div>

      <div id="submitErr" class="err"></div>
      <div id="submitOk" class="ok"></div>

      <div class="footer-actions">
        <button id="submitBtn" type="submit">Submit feedback</button>
        <button id="restartBtn" type="button" class="secondary">Start over</button>
        <span class="tiny" id="sessionNote"></span>
      </div>
    </form>
  </div>

  <script>
    // IMPORTANT: if hosted on same domain, use relative paths
    const API = ""; // keep blank to call same-origin, e.g. /api/start-session

    const SESSION_KEY = "tl360_session_v1";

    const scale = [
      { label: "Never", value: 1 },
      { label: "Rarely", value: 2 },
      { label: "Sometimes", value: 3 },
      { label: "Often", value: 4 },
      { label: "Always", value: 5 },
    ];

    const questions = [
      { id: "q2", text: "The team leader sets clear expectations and goals." },
      { id: "q3", text: "The team leader makes fair, well-informed decisions." },
      { id: "q4", text: "The team leader remains composed and professional under pressure." },

      { id: "q5", text: "The team leader communicates openly and transparently." },
      { id: "q6", text: "The team leader listens actively and considers feedback." },
      { id: "q7", text: "The team leader provides timely and useful updates." },

      { id: "q8", text: "The team leader supports professional growth and development." },
      { id: "q9", text: "The team leader provides constructive, actionable feedback." },
      { id: "q10", text: "The team leader acknowledges and recognizes good performance." },

      { id: "q11", text: "The team leader promotes a positive and respectful team culture." },
      { id: "q12", text: "The team leader encourages collaboration and teamwork." },
      { id: "q13", text: "The team leader manages conflicts effectively and professionally." },

      { id: "q14", text: "The team leader ensures tasks and commitments are completed on time." },
      { id: "q15", text: "The team leader holds themselves and others accountable." },
      { id: "q16", text: "The team leader effectively prioritizes and delegates tasks." },
    ];

    function show(el, yes) { el.style.display = yes ? "block" : "none"; }
    function setErr(el, msg) { el.textContent = msg || ""; show(el, !!msg); }
    function setOk(el, msg) { el.textContent = msg || ""; show(el, !!msg); }

    function renderQuestion(q) {
      const wrap = document.getElementById(q.id);
      wrap.innerHTML = "";

      const title = document.createElement("label");
      title.className = "title";
      title.textContent = q.text;

      const radios = document.createElement("div");
      radios.className = "radios";

      for (const opt of scale) {
        const lbl = document.createElement("label");

        const input = document.createElement("input");
        input.type = "radio";
        input.name = q.id;
        input.value = opt.value;
        input.required = true;

        const span = document.createElement("span");
        span.textContent = opt.label;

        lbl.appendChild(input);
        lbl.appendChild(span);
        radios.appendChild(lbl);
      }

      wrap.appendChild(title);
      wrap.appendChild(radios);
    }

    questions.forEach(renderQuestion);

    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");

    const codeInput = document.getElementById("codeInput");
    const startBtn = document.getElementById("startBtn");
    const step1Err = document.getElementById("step1Err");
    const step1Ok = document.getElementById("step1Ok");

    const submitErr = document.getElementById("submitErr");
    const submitOk = document.getElementById("submitOk");
    const submitBtn = document.getElementById("submitBtn");
    const restartBtn = document.getElementById("restartBtn");
    const sessionNote = document.getElementById("sessionNote");

    function clearSession() {
      localStorage.removeItem(SESSION_KEY);
    }

    function loadSession() {
      try {
        const raw = localStorage.getItem(SESSION_KEY);
        if (!raw) return null;
        const s = JSON.parse(raw);

        // Soft expiry: 24 hours (prevents the “session expired” frustration)
        const ageMs = Date.now() - (s.startedAt || 0);
        if (ageMs > 24 * 60 * 60 * 1000) {
          clearSession();
          return null;
        }
        return s;
      } catch {
        clearSession();
        return null;
      }
    }

    function saveSession(session) {
      localStorage.setItem(SESSION_KEY, JSON.stringify(session));
    }

    function goToStep2(session) {
      show(step1, false);
      show(step2, true);
      setErr(step1Err, "");
      setOk(step1Ok, "");
      setErr(submitErr, "");
      setOk(submitOk, "");
      sessionNote.textContent = session?.campaignId ? `Code verified. (Cycle stored silently: ${session.campaignId})` : "";
    }

    function goToStep1() {
      show(step2, false);
      show(step1, true);
      setErr(submitErr, "");
      setOk(submitOk, "");
      codeInput.value = "";
    }

    // Resume if user refreshes mid-form
    const existing = loadSession();
    if (existing) {
      goToStep2(existing);
    }

    startBtn.addEventListener("click", async () => {
      const code = (codeInput.value || "").trim().toUpperCase();
      setErr(step1Err, "");
      setOk(step1Ok, "");

      if (!code) return setErr(step1Err, "Please enter a code.");

      startBtn.disabled = true;
      startBtn.textContent = "Checking…";

      try {
        const res = await fetch(API + "/api/start-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          startBtn.disabled = false;
          startBtn.textContent = "Start";
          return setErr(step1Err, data.error || "Unable to start. Please check your code.");
        }

        const session = {
          code,
          campaignId: data.campaignId,
          teamLeaderId: data.teamLeaderId,
          startedAt: Date.now()
        };

        saveSession(session);
        setOk(step1Ok, "Code accepted. Loading questionnaire…");
        goToStep2(session);

        startBtn.disabled = false;
        startBtn.textContent = "Start";
      } catch (e) {
        console.error(e);
        startBtn.disabled = false;
        startBtn.textContent = "Start";
        setErr(step1Err, "Network error. Please try again.");
      }
    });

    restartBtn.addEventListener("click", () => {
      clearSession();
      goToStep1();
      show(step1Ok, false);
      show(step1Err, false);
      // reset form fields
      step2.reset();
    });

    step2.addEventListener("submit", async (e) => {
      e.preventDefault();
      setErr(submitErr, "");
      setOk(submitOk, "");

      const session = loadSession();
      if (!session || !session.code || !session.campaignId || !session.teamLeaderId) {
        // This is the main fix: avoid vague “expired”; tell user exactly what to do.
        return setErr(submitErr, "Your session is missing. Please click “Start over” and re-enter your code.");
      }

      // Collect scores
      const scores = {};
      for (const q of questions) {
        const checked = step2.querySelector(`input[name="${q.id}"]:checked`);
        if (!checked) return setErr(submitErr, "Please answer every question before submitting.");
        scores[q.id] = Number(checked.value);
      }

      // Text areas are required
      const strengthsText = document.getElementById("strengthsText").value.trim();
      const devText = document.getElementById("devText").value.trim();
      const otherText = document.getElementById("otherText").value.trim();

      if (!strengthsText || !devText || !otherText) {
        return setErr(submitErr, "Please complete all written questions before submitting.");
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting…";

      try {
        const res = await fetch(API + "/api/submit-feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            code: session.code,
            campaignId: session.campaignId,
            teamLeaderId: session.teamLeaderId,
            scores,
            strengthsText,
            devText,
            otherText
          })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit feedback";
          return setErr(submitErr, data.error || "Unable to submit feedback. Please try again.");
        }

        setOk(submitOk, "Thanks — your feedback has been submitted successfully.");
        clearSession();
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit feedback";

        // Disable form after submit
        Array.from(step2.querySelectorAll("input, textarea, button")).forEach(el => {
          if (el.id !== "restartBtn") el.disabled = true;
        });
      } catch (err) {
        console.error(err);
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit feedback";
        setErr(submitErr, "Network error while submitting. Please try again.");
      }
    });
  </script>
</body>
</html>
