<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Anonymous Team Leader Feedback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f5;
      margin: 0;
      padding: 2rem;
    }
    .card {
      max-width: 720px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 1.8rem 2.2rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.12);
    }
    h1 { margin-top: 0; }
    .muted { color: #6b7280; font-size: 0.9rem; }
    label { font-weight: 600; display: block; margin-top: 1rem; }
    input, textarea {
      width: 100%;
      padding: 0.55rem;
      margin-top: 0.3rem;
      border-radius: 6px;
      border: 1px solid #d4d4d8;
      font-size: 0.95rem;
    }
    textarea { min-height: 90px; }
    button {
      margin-top: 1.2rem;
      padding: 0.55rem 1.2rem;
      border-radius: 6px;
      border: none;
      background: #2563eb;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .error { color: #b91c1c; margin-top: 0.6rem; }
    .ok { color: #047857; margin-top: 0.6rem; }
    .hidden { display: none; }
    .likert label {
      display: inline-block;
      margin-right: 0.8rem;
      font-weight: normal;
    }
    .actions {
      display: flex;
      gap: 0.6rem;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

<div class="card">
  <h1>Team Leader Feedback</h1>
  <p class="muted">
    Your feedback is anonymous. Please focus on behaviours and experiences rather than names or specific incidents.
  </p>

  <!-- STEP 1 -->
  <div id="step1">
    <h3>Step 1: Enter your feedback code</h3>
    <label>Feedback code</label>
    <input id="codeInput" placeholder="e.g. ABCD-1234" />
    <div id="step1Err" class="error"></div>
    <div id="step1Ok" class="ok"></div>
    <button id="startBtn">Start feedback</button>
  </div>

  <!-- STEP 2 -->
  <div id="step2" class="hidden">
    <h3>Step 2: Feedback questions</h3>

    <label>1. This team leader demonstrates effective leadership</label>
    <div class="likert">
      <label><input type="radio" name="q1" value="1"> 1</label>
      <label><input type="radio" name="q1" value="2"> 2</label>
      <label><input type="radio" name="q1" value="3"> 3</label>
      <label><input type="radio" name="q1" value="4"> 4</label>
      <label><input type="radio" name="q1" value="5"> 5</label>
    </div>

    <label>2. Communication is clear and consistent</label>
    <div class="likert">
      <label><input type="radio" name="q2" value="1"> 1</label>
      <label><input type="radio" name="q2" value="2"> 2</label>
      <label><input type="radio" name="q2" value="3"> 3</label>
      <label><input type="radio" name="q2" value="4"> 4</label>
      <label><input type="radio" name="q2" value="5"> 5</label>
    </div>

    <label>Strengths</label>
    <textarea id="strengthsText"></textarea>

    <label>Areas for development</label>
    <textarea id="devText"></textarea>

    <label>Anything else that would help them succeed?</label>
    <textarea id="otherText"></textarea>

    <div id="submitErr" class="error"></div>
    <div id="submitOk" class="ok"></div>

    <div class="actions">
      <button id="submitBtn">Submit feedback</button>
      <button id="restartBtn" class="secondary">Start over</button>
    </div>
  </div>
</div>

<script>
const API = "";

function show(id) {
  document.getElementById(id).classList.remove("hidden");
}
function hide(id) {
  document.getElementById(id).classList.add("hidden");
}
function err(id, msg) {
  document.getElementById(id).textContent = msg || "";
}
function ok(id, msg) {
  document.getElementById(id).textContent = msg || "";
}

function saveSession(token) {
  localStorage.setItem("feedbackSession", JSON.stringify({
    token,
    startedAt: Date.now()
  }));
}
function loadSession() {
  try {
    return JSON.parse(localStorage.getItem("feedbackSession"));
  } catch {
    return null;
  }
}
function clearSession() {
  localStorage.removeItem("feedbackSession");
}

document.getElementById("startBtn").onclick = async () => {
  err("step1Err"); ok("step1Ok");

  const code = document.getElementById("codeInput").value.trim().toUpperCase();
  if (!code) return err("step1Err", "Please enter a code.");

  const btn = document.getElementById("startBtn");
  btn.disabled = true; btn.textContent = "Checking…";

  try {
    const res = await fetch("/api/start-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code })
    });
    const data = await res.json();

    if (!res.ok || !data.sessionToken) {
      btn.disabled = false; btn.textContent = "Start feedback";
      return err("step1Err", data.error || "Invalid code.");
    }

    saveSession(data.sessionToken);
    ok("step1Ok", "Code accepted. Loading questions…");

    hide("step1");
    show("step2");

  } catch (e) {
    err("step1Err", "Server error. Please try again.");
  } finally {
    btn.disabled = false; btn.textContent = "Start feedback";
  }
};

document.getElementById("submitBtn").onclick = async () => {
  err("submitErr"); ok("submitOk");

  const session = loadSession();
  if (!session?.token) {
    return err("submitErr", "Your session is missing. Please start over.");
  }

  const q1 = document.querySelector("input[name='q1']:checked")?.value;
  const q2 = document.querySelector("input[name='q2']:checked")?.value;
  const strengthsText = document.getElementById("strengthsText").value.trim();
  const devText = document.getElementById("devText").value.trim();
  const otherText = document.getElementById("otherText").value.trim();

  if (!q1 || !q2 || !strengthsText || !devText) {
    return err("submitErr", "Please answer all required questions.");
  }

  const scores = { q1: Number(q1), q2: Number(q2) };

  const btn = document.getElementById("submitBtn");
  btn.disabled = true; btn.textContent = "Submitting…";

  try {
    const res = await fetch("/api/submit-feedback", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + session.token
      },
      body: JSON.stringify({
        scores,
        strengthsText,
        devText,
        otherText
      })
    });

    const data = await res.json();

    if (!res.ok) {
      btn.disabled = false; btn.textContent = "Submit feedback";
      return err("submitErr", data.error || "Submission failed.");
    }

    ok("submitOk", "Thank you — your feedback has been submitted.");
    clearSession();
    btn.disabled = true;

  } catch (e) {
    err("submitErr", "Server error saving feedback.");
    btn.disabled = false;
  }
};

document.getElementById("restartBtn").onclick = () => {
  clearSession();
  location.reload();
};
</script>

</body>
</html>
