<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Team Leader Feedback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #f8fafc, #eef2ff);
      margin: 0;
      padding: 2rem 1rem;
      color: #0f172a;
    }
    .shell {
      max-width: 960px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
      padding: 1.6rem 1.8rem;
      border: 1px solid #e5e7eb;
    }
    h1 { margin: 0; font-size: 1.8rem; }
    .subtitle { color:#475569; margin-top: 0.35rem; line-height: 1.4; }
    .topline { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom: 1rem; }
    .badge { font-size: 0.85rem; padding: 0.15rem 0.6rem; border-radius:999px; background:#eff6ff; border:1px solid #bfdbfe; color:#1d4ed8; }
    .progress-wrap { margin-top: 0.8rem; }
    .progress-meta { display:flex; justify-content:space-between; font-size:0.9rem; color:#64748b; margin-bottom:0.3rem; }
    .progress {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow:hidden;
    }
    .progress > div {
      height: 100%;
      width: 0%;
      background: #2563eb;
      transition: width 200ms ease;
    }

    .section-title { margin-top: 1.2rem; font-size: 1.15rem; }
    .muted { color:#64748b; font-size:0.92rem; line-height:1.4; }

    .box {
      border: 1px solid #e5e7eb;
      background:#fafafa;
      border-radius: 14px;
      padding: 1rem 1.1rem;
      margin-top: 1rem;
    }

    label { display:block; font-weight:700; margin-top: 0.9rem; }
    .qhelp { font-weight: 500; color:#64748b; font-size:0.92rem; margin-top: 0.2rem; }

    .scale {
      display:flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.55rem;
    }
    .scale label {
      margin: 0;
      font-weight: 600;
      border: 1px solid #d1d5db;
      background: #fff;
      padding: 0.45rem 0.7rem;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
    }
    .scale input { display:none; }
    .scale input:checked + span {
      background:#2563eb;
      color:#fff;
      border-color:#2563eb;
    }
    .scale span {
      display:inline-block;
      padding: 0.05rem 0.2rem;
      border-radius: 999px;
    }

    input[type="text"], textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 0.75rem 0.85rem;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      font-size: 1rem;
      margin-top: 0.45rem;
      background:#fff;
    }
    textarea { min-height: 120px; resize: vertical; }

    .actions { display:flex; justify-content:flex-end; gap:0.6rem; margin-top: 1.1rem; }
    button {
      padding: 0.65rem 1rem;
      border-radius: 12px;
      border: none;
      background: #2563eb;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 700;
    }
    button.secondary { background:#e5e7eb; color:#111827; }
    button:hover { filter: brightness(0.95); }

    .error {
      margin-top: 0.8rem;
      padding: 0.75rem 0.9rem;
      border-radius: 12px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
      display:none;
      white-space: pre-wrap;
    }
    .ok {
      margin-top: 0.8rem;
      padding: 0.75rem 0.9rem;
      border-radius: 12px;
      background: #ecfdf5;
      border: 1px solid #bbf7d0;
      color: #166534;
      display:none;
      white-space: pre-wrap;
    }
    .divider { height:1px; background:#e5e7eb; margin: 1.1rem 0; }

    .smallnote { margin-top:0.6rem; color:#64748b; font-size:0.9rem; }

    /* Steps */
    #step2 { display:none; }
    #step3 { display:none; }

  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div class="topline">
        <div>
          <div class="badge">Anonymous 360° feedback</div>
          <h1>Team Leader Feedback</h1>
          <div class="subtitle">
            Your feedback is anonymous. Please focus on observable behaviours and your experience over the review period.
          </div>
        </div>
      </div>

      <div class="progress-wrap">
        <div class="progress-meta">
          <div id="stepLabel">Step 1 of 2 · Enter your feedback code</div>
          <div id="pctLabel">0%</div>
        </div>
        <div class="progress"><div id="bar"></div></div>
      </div>

      <div id="step1" class="box">
        <h2 class="section-title" style="margin-top:0;">Step 1 · Enter your code</h2>
        <div class="muted">
          Use the one-time feedback code provided to you. This links your feedback to the correct team leader without revealing who you are.
        </div>

        <label for="codeInput">Feedback code</label>
        <input type="text" id="codeInput" placeholder="e.g. ABCD-EFGH" autocomplete="off" />

        <div class="actions">
          <button id="startBtn">Start feedback</button>
        </div>

        <div id="step1Err" class="error"></div>
        <div id="step1Ok" class="ok"></div>
      </div>

      <div id="step2" class="box">
        <h2 class="section-title" style="margin-top:0;">Step 2 · Questionnaire</h2>
        <div class="muted">
          Please answer all questions. Scores use 1 (strongly disagree) to 5 (strongly agree).
        </div>

        <div class="divider"></div>

        <!-- Leadership -->
        <h3 class="section-title">Leadership &amp; Management</h3>

        <div class="q">
          <label>1) Demonstrates strong leadership and clear direction</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q2"></div>
        </div>

        <div class="q">
          <label>2) Makes fair and consistent decisions</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q3"></div>
        </div>

        <div class="q">
          <label>3) Takes ownership and accountability</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q4"></div>
        </div>

        <div class="divider"></div>

        <!-- Communication -->
        <h3 class="section-title">Communication</h3>

        <div class="q">
          <label>4) Communicates clearly and in a timely way</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q5"></div>
        </div>

        <div class="q">
          <label>5) Listens and considers different viewpoints</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q6"></div>
        </div>

        <div class="q">
          <label>6) Gives helpful feedback and recognition</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q7"></div>
        </div>

        <div class="divider"></div>

        <!-- Team Support -->
        <h3 class="section-title">Team Support &amp; Development</h3>

        <div class="q">
          <label>7) Supports the team to perform at their best</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q8"></div>
        </div>

        <div class="q">
          <label>8) Helps develop skills and confidence</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q9"></div>
        </div>

        <div class="q">
          <label>9) Creates an environment where people feel supported</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q10"></div>
        </div>

        <div class="divider"></div>

        <!-- Collaboration -->
        <h3 class="section-title">Collaboration &amp; Culture</h3>

        <div class="q">
          <label>10) Encourages collaboration and teamwork</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q11"></div>
        </div>

        <div class="q">
          <label>11) Treats people with respect and fairness</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q12"></div>
        </div>

        <div class="q">
          <label>12) Contributes to a positive team culture</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q13"></div>
        </div>

        <div class="divider"></div>

        <!-- Execution -->
        <h3 class="section-title">Execution &amp; Accountability</h3>

        <div class="q">
          <label>13) Sets clear expectations and follows through</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q14"></div>
        </div>

        <div class="q">
          <label>14) Helps remove blockers and keeps work moving</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q15"></div>
        </div>

        <div class="q">
          <label>15) Focuses on outcomes and quality of delivery</label>
          <div class="qhelp">1 = strongly disagree · 5 = strongly agree</div>
          <div class="scale" data-qid="q16"></div>
        </div>

        <div class="divider"></div>

        <h3 class="section-title">Open comments</h3>
        <div class="muted">
          Please avoid names or very specific situations that could identify you or others.
          Focus on themes and behaviours. These questions are required.
        </div>

        <label for="strengthsText">What are this team leader’s greatest strengths?</label>
        <textarea id="strengthsText" placeholder="Write your answer here (required)."></textarea>

        <label for="devText">What could this team leader improve or develop further?</label>
        <textarea id="devText" placeholder="Write your answer here (required)."></textarea>

        <label for="otherText">Anything else that would help this team leader succeed?</label>
        <textarea id="otherText" placeholder="Write your answer here (required)."></textarea>

        <div class="actions">
          <button id="submitBtn">Submit feedback</button>
          <button id="restartBtn" class="secondary">Start over</button>
        </div>

        <div id="submitErr" class="error"></div>
        <div id="submitOk" class="ok"></div>

        <div class="smallnote">
          If you refresh the page mid-way, you can continue as long as your session token is still valid (2 hours).
        </div>
      </div>

      <div id="step3" class="box">
        <h2 class="section-title" style="margin-top:0;">Thank you</h2>
        <div class="muted">
          Your feedback has been submitted successfully.
        </div>
        <div class="actions">
          <button id="restartBtn2" class="secondary">Submit another code</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    const API = ""; // same origin

    // --- UI helpers ---
    const stepLabel = document.getElementById("stepLabel");
    const pctLabel = document.getElementById("pctLabel");
    const bar = document.getElementById("bar");

    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const step3 = document.getElementById("step3");

    const step1Err = document.getElementById("step1Err");
    const step1Ok = document.getElementById("step1Ok");
    const submitErr = document.getElementById("submitErr");
    const submitOk = document.getElementById("submitOk");

    function show(el, on) { el.style.display = on ? "block" : "none"; }
    function setErr(el, msg) { el.textContent = msg || ""; el.style.display = msg ? "block" : "none"; }
    function setOk(el, msg) { el.textContent = msg || ""; el.style.display = msg ? "block" : "none"; }

    function setProgress(step) {
      if (step === 1) {
        stepLabel.textContent = "Step 1 of 2 · Enter your feedback code";
        pctLabel.textContent = "0%";
        bar.style.width = "0%";
      } else if (step === 2) {
        stepLabel.textContent = "Step 2 of 2 · Questionnaire";
        pctLabel.textContent = "60%";
        bar.style.width = "60%";
      } else {
        stepLabel.textContent = "Complete";
        pctLabel.textContent = "100%";
        bar.style.width = "100%";
      }
    }

    // --- session storage (only sessionToken) ---
    const STORAGE_KEY = "tl360_session_v1";

    function saveSession(session) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(session));
    }
    function loadSession() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }
    function clearSession() {
      localStorage.removeItem(STORAGE_KEY);
    }

    function gotoStep1() {
      show(step1, true);
      show(step2, false);
      show(step3, false);
      setProgress(1);
      setErr(step1Err, "");
      setOk(step1Ok, "");
      setErr(submitErr, "");
      setOk(submitOk, "");
    }

    function gotoStep2() {
      show(step1, false);
      show(step2, true);
      show(step3, false);
      setProgress(2);
      setErr(step1Err, "");
      setOk(step1Ok, "");
      setErr(submitErr, "");
      setOk(submitOk, "");
    }

    function gotoStep3() {
      show(step1, false);
      show(step2, false);
      show(step3, true);
      setProgress(3);
      setErr(submitErr, "");
      setOk(submitOk, "");
    }

    // --- Build rating scales (required) ---
    function buildScale(container) {
      const qid = container.getAttribute("data-qid");
      // 1..5
      for (let i = 1; i <= 5; i++) {
        const id = `${qid}_${i}`;
        const lbl = document.createElement("label");

        const input = document.createElement("input");
        input.type = "radio";
        input.name = qid;
        input.value = String(i);
        input.id = id;

        const span = document.createElement("span");
        span.textContent = i;

        // Important: input must be before span for CSS selector
        lbl.appendChild(input);
        lbl.appendChild(span);
        container.appendChild(lbl);
      }
    }

    document.querySelectorAll(".scale").forEach(buildScale);

    // --- Start session ---
    const codeInput = document.getElementById("codeInput");
    const startBtn = document.getElementById("startBtn");

    startBtn.addEventListener("click", async () => {
      const code = (codeInput.value || "").trim().toUpperCase();
      setErr(step1Err, "");
      setOk(step1Ok, "");
      if (!code) return setErr(step1Err, "Please enter a code.");

      startBtn.disabled = true;
      startBtn.textContent = "Checking...";

      try {
        const res = await fetch(API + "/api/start-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          startBtn.disabled = false;
          startBtn.textContent = "Start feedback";
          return setErr(step1Err, data.error || "Unable to start. Please check your code.");
        }

        if (!data.sessionToken) {
          startBtn.disabled = false;
          startBtn.textContent = "Start feedback";
          return setErr(step1Err, "Server did not return a session token. Please try again.");
        }

        saveSession({ sessionToken: data.sessionToken, startedAt: Date.now() });
        setOk(step1Ok, "Code accepted. Loading questionnaire...");
        gotoStep2();

      } catch (e) {
        console.error(e);
        setErr(step1Err, "Network error. Please try again.");
      } finally {
        startBtn.disabled = false;
        startBtn.textContent = "Start feedback";
      }
    });

    // --- Submit feedback ---
    const submitBtn = document.getElementById("submitBtn");
    const restartBtn = document.getElementById("restartBtn");
    const restartBtn2 = document.getElementById("restartBtn2");

    function getScores() {
      const qids = ["q2","q3","q4","q5","q6","q7","q8","q9","q10","q11","q12","q13","q14","q15","q16"];
      const scores = {};
      for (const qid of qids) {
        const checked = document.querySelector(`input[name="${qid}"]:checked`);
        if (!checked) return { error: `Please answer all score questions (missing ${qid}).` };
        scores[qid] = Number(checked.value);
      }
      return { scores };
    }

    submitBtn.addEventListener("click", async () => {
      setErr(submitErr, "");
      setOk(submitOk, "");

      const session = loadSession();
      if (!session || !session.sessionToken) {
        return setErr(submitErr, "Your session is missing. Please click “Start over” and re-enter your code.");
      }

      const { scores, error } = getScores();
      if (error) return setErr(submitErr, error);

      const strengthsText = document.getElementById("strengthsText").value.trim();
      const devText = document.getElementById("devText").value.trim();
      const otherText = document.getElementById("otherText").value.trim();

      if (!strengthsText || !devText || !otherText) {
        return setErr(submitErr, "Please complete all written questions before submitting.");
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";

      try {
        const res = await fetch(API + "/api/submit-feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sessionToken: session.sessionToken,
            scores,
            strengthsText,
            devText,
            otherText
          })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit feedback";
          return setErr(submitErr, data.error || "Server error saving feedback.");
        }

        clearSession();
        setOk(submitOk, "Submitted successfully.");
        gotoStep3();

      } catch (e) {
        console.error(e);
        setErr(submitErr, "Network error. Please try again.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit feedback";
      }
    });

    // Start over
    function doRestart() {
      clearSession();
      // reset form selections
      document.querySelectorAll('input[type="radio"]').forEach(i => i.checked = false);
      document.getElementById("strengthsText").value = "";
      document.getElementById("devText").value = "";
      document.getElementById("otherText").value = "";
      codeInput.value = "";
      gotoStep1();
    }

    restartBtn.addEventListener("click", doRestart);
    restartBtn2.addEventListener("click", doRestart);

    // Resume on reload if a token exists
    const existing = loadSession();
    if (existing && existing.sessionToken) {
      gotoStep2();
    } else {
      gotoStep1();
    }
  </script>
</body>
</html>
