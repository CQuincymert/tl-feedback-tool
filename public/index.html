<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Leader Feedback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; background:#f5f7fb; }
    .card { max-width:800px; margin:40px auto; background:#fff; padding:24px; border-radius:10px; box-shadow:0 10px 25px rgba(0,0,0,.08); }
    h1,h2 { margin-top:0 }
    .hidden { display:none }
    .error { background:#fdecea; color:#b42318; padding:10px; border-radius:6px; margin-top:12px }
    .ok { background:#e7f6ec; color:#05603a; padding:10px; border-radius:6px; margin-top:12px }
    button { padding:10px 16px; border-radius:6px; border:none; background:#2563eb; color:#fff; cursor:pointer }
    button:disabled { opacity:.6; cursor:not-allowed }
    textarea { width:100%; min-height:90px }
    .q { margin:16px 0 }
  </style>
</head>
<body>

<div class="card">
  <h1>Team Leader Feedback</h1>
  <p>Your feedback is anonymous.</p>

  <!-- STEP 1 -->
  <div id="step1">
    <h2>Step 1 – Enter your code</h2>
    <input id="codeInput" placeholder="ABC1-XYZ9" />
    <br><br>
    <button id="startBtn">Start feedback</button>
    <div id="step1Err" class="error hidden"></div>
    <div id="step1Ok" class="ok hidden"></div>
  </div>

  <!-- STEP 2 -->
  <div id="step2" class="hidden">
    <h2>Step 2 – Questionnaire</h2>

    <div class="q">
      <strong>Leadership & Management</strong><br>
      Score:
      <select data-score="leadership" required>
        <option value="">Select</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>
    </div>

    <div class="q">
      <strong>Communication</strong><br>
      Score:
      <select data-score="communication" required>
        <option value="">Select</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      </select>
    </div>

    <div class="q">
      <strong>Strengths</strong>
      <textarea id="strengthsText" required></textarea>
    </div>

    <div class="q">
      <strong>Development areas</strong>
      <textarea id="devText" required></textarea>
    </div>

    <div class="q">
      <strong>Anything else?</strong>
      <textarea id="otherText" required></textarea>
    </div>

    <button id="submitBtn">Submit feedback</button>
    <button id="resetBtn" type="button">Start over</button>

    <div id="submitErr" class="error hidden"></div>
    <div id="submitOk" class="ok hidden"></div>
  </div>
</div>

<script>
const API = "";
const startBtn = document.getElementById("startBtn");
const submitBtn = document.getElementById("submitBtn");

function show(el){ el.classList.remove("hidden"); }
function hide(el){ el.classList.add("hidden"); }
function setErr(id,msg){ const e=document.getElementById(id); e.textContent=msg; show(e); }
function setOk(id,msg){ const e=document.getElementById(id); e.textContent=msg; show(e); }

function saveSession(token){
  localStorage.setItem("tlSessionToken", token);
}
function loadSession(){
  return localStorage.getItem("tlSessionToken");
}
function clearSession(){
  localStorage.removeItem("tlSessionToken");
}

function goToStep2(){
  hide(document.getElementById("step1"));
  show(document.getElementById("step2"));
}

startBtn.onclick = async () => {
  hide(step1Err); hide(step1Ok);
  const code = document.getElementById("codeInput").value.trim().toUpperCase();
  if(!code) return setErr("step1Err","Please enter a code.");

  startBtn.disabled = true;
  try {
    const res = await fetch(API + "/api/start-session",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ code })
    });
    const data = await res.json();
    if(!res.ok) return setErr("step1Err", data.error || "Invalid code.");

    if(!data.sessionToken) return setErr("step1Err","No session token returned.");

    saveSession(data.sessionToken);
    setOk("step1Ok","Code accepted. Loading questionnaire...");
    goToStep2();

  } catch(e){
    setErr("step1Err","Server error. Please try again.");
  } finally {
    startBtn.disabled=false;
  }
};

submitBtn.onclick = async () => {
  hide(submitErr); hide(submitOk);
  const sessionToken = loadSession();
  if(!sessionToken) return setErr("submitErr","Missing sessionToken.");

  const scores = {};
  document.querySelectorAll("[data-score]").forEach(s=>{
    if(!s.value) throw "All scores required";
    scores[s.dataset.score] = Number(s.value);
  });

  submitBtn.disabled=true;
  try{
    const res = await fetch(API + "/api/submit-feedback",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        sessionToken,
        scores,
        strengthsText: strengthsText.value.trim(),
        devText: devText.value.trim(),
        otherText: otherText.value.trim()
      })
    });
    const data = await res.json();
    if(!res.ok) return setErr("submitErr", data.error || "Failed to submit.");

    setOk("submitOk","Thank you! Your feedback has been submitted.");
    clearSession();
    submitBtn.disabled=true;

  } catch(e){
    setErr("submitErr","Server error saving feedback.");
  }
};

resetBtn.onclick = () => {
  clearSession();
  location.reload();
};

// Resume session if valid
if(loadSession()){
  goToStep2();
}
</script>
</body>
</html>
