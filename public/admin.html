<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>360° Review – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f5;
      margin: 0;
      padding: 2rem 1rem;
      color: #111827;
    }
    .shell {
      max-width: 1150px;
      margin: 0 auto;
      background: #fff;
      border-radius: 14px;
      padding: 1.8rem 2.3rem;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
    }
    h1 { margin: 0 0 0.25rem 0; }
    h2 { margin-top: 1.6rem; }
    h3 { margin-top: 1.2rem; }
    .muted { color: #6b7280; font-size: 0.9rem; }
    .row { display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap; }
    select, input[type="text"], input[type="number"], input[type="password"] {
      padding: 0.45rem 0.6rem;
      border-radius: 8px;
      border: 1px solid #d4d4d8;
      font-size: 0.95rem;
      background: #fff;
    }
    button {
      padding: 0.48rem 0.9rem;
      border-radius: 8px;
      border: none;
      background: #2563eb;
      color: white;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
    }
    button.secondary { background: #e5e7eb; color: #111827; }
    button.danger { background: #dc2626; }
    button:hover { filter: brightness(0.95); }
    hr { margin: 1.6rem 0; border: none; border-top: 1px solid #e5e7eb; }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 0.8rem;
      font-size: 0.95rem;
    }
    th, td {
      border: 1px solid #e4e4e7;
      padding: 0.55rem 0.65rem;
      text-align: left;
      vertical-align: top;
    }
    th { background: #f9fafb; }
    .pill {
      display:inline-block;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid #d4d4d8;
    }
    .pill.good { background:#ecfdf5; border-color:#22c55e; color:#15803d; }
    .pill.mixed { background:#fefce8; border-color:#f97316; color:#92400e; }
    .pill.bad { background:#fef2f2; border-color:#ef4444; color:#b91c1c; }
    .layout {
      display:grid;
      grid-template-columns: 2.1fr 1.4fr;
      gap: 1.2rem;
      align-items:start;
    }
    canvas { background:#f9fafb; border-radius: 12px; padding: 0.6rem; border:1px solid #e5e7eb; }
    .comment-block {
      background: #f9fafb;
      border-radius: 10px;
      padding: 0.75rem 0.9rem;
      margin-bottom: 0.6rem;
      border: 1px solid #e5e7eb;
      white-space: pre-wrap;
    }
    details.settings {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 0.9rem 1rem;
      background: #fafafa;
      margin-top: 1rem;
    }
    details.settings > summary {
      cursor: pointer;
      font-weight: 700;
      list-style: none;
    }
    details.settings > summary::-webkit-details-marker { display: none; }
    .chip {
      display:inline-flex;
      align-items:center;
      gap:0.4rem;
      padding: 0.25rem 0.6rem;
      border: 1px solid #d4d4d8;
      border-radius: 999px;
      background: #fff;
      margin: 0.2rem 0.25rem 0.2rem 0;
      font-size: 0.9rem;
    }
    .chip button {
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.85rem;
      background: #e5e7eb;
      color: #111827;
    }
    .chip button.d { background:#fee2e2; color:#991b1b; }
    .box {
      background:#fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 0.9rem 1rem;
    }
    pre {
      margin-top:0.7rem;
      background:#0b1220;
      color:#e5e7eb;
      padding:0.85rem;
      border-radius:10px;
      border:1px solid #111827;
      max-height:240px;
      overflow:auto;
      font-size: 0.9rem;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="shell">

    <div id="login-block" class="box">
      <h1>Admin Login</h1>
      <p class="muted">Enter the admin password to access dashboards and code generation.</p>
      <div class="row">
        <input type="password" id="admin-password" placeholder="Admin password" />
        <button id="login-btn">Login</button>
      </div>
      <div id="login-error" class="muted" style="color:#b91c1c; margin-top:0.4rem;"></div>
    </div>

    <div id="admin-content" style="display:none;">
      <h1>360° Review – Admin Dashboard</h1>
      <p class="muted">View anonymous summaries, generate codes, manage cycles and team leader list.</p>

      <!-- VIEW CYCLE (main, always visible) -->
      <div class="box" style="margin-top:1rem;">
        <h2 style="margin-top:0;">View cycle</h2>
        <div class="row">
          <label class="muted">Cycle:</label>
          <select id="campaign-select" style="min-width:320px;"></select>
          <button id="refresh-overview">Refresh overview</button>
          <span class="muted" id="cycle-status"></span>
        </div>

        <h3>Overview</h3>
        <table id="overview-table">
          <thead>
            <tr>
              <th style="width:180px;">Team Leader</th>
              <th style="width:120px;">Responses</th>
              <th style="width:140px;">Overall avg</th>
              <th>Summary</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h3>Detail</h3>
        <p class="muted" id="detail-intro">Select a team leader from the overview to see detail.</p>

        <div id="detail-block" style="display:none;">
          <div class="layout">
            <div>
              <p><strong id="detail-title"></strong></p>
              <p class="muted" id="detail-summary-text"></p>

              <div class="row" style="margin:0.6rem 0 0.6rem;">
                <button id="ai-summary-btn">Generate AI summary of comments</button>
                <button id="pdf-btn" class="secondary">Download PDF report</button>
                <button id="delete-responses-btn" class="danger">Delete responses (TL in this cycle)</button>
              </div>

              <p class="muted" id="ai-summary-text" style="margin-top:0.3rem;"></p>

              <h4>Action areas (simple)</h4>
              <div id="action-areas" class="muted"></div>

              <h4>Category scores</h4>
              <table id="category-table">
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Avg score</th>
                    <th>Interpretation</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>

              <div id="comments-section" style="margin-top:1rem;"></div>

              <h4 style="margin-top:1.2rem;">Compare cycles (any two)</h4>
              <div class="row">
                <label class="muted">From:</label>
                <select id="cmp-from" style="min-width:220px;"></select>
                <label class="muted">To:</label>
                <select id="cmp-to" style="min-width:220px;"></select>
                <button id="cmp-btn" class="secondary">Compare</button>
                <label class="muted" style="display:flex; align-items:center; gap:0.4rem;">
                  <input type="checkbox" id="cmp-ai" />
                  AI change summary
                </label>
              </div>
              <div id="cmp-out" class="muted" style="margin-top:0.6rem;"></div>
            </div>

            <div>
              <h4>Charts</h4>
              <canvas id="radarChart" height="220"></canvas>
              <canvas id="barChart" height="220" style="margin-top:1rem;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS DROPDOWN -->
      <details class="settings">
        <summary>Settings</summary>

        <div style="margin-top:0.9rem;" class="box">
          <h2 style="margin-top:0;">Generate passcodes</h2>
          <p class="muted">Generate anonymous codes for a specific TL and cycle.</p>

          <div class="row">
            <label class="muted">Cycle:</label>
            <select id="gen-campaign" style="min-width:320px;"></select>

            <label class="muted">Team Leader:</label>
            <select id="gen-tl" style="min-width:220px;"></select>

            <label class="muted">Count:</label>
            <input type="number" id="gen-count" min="1" max="500" value="10" style="width:90px;" />

            <button id="gen-btn">Generate codes</button>
          </div>

          <pre id="gen-output"></pre>
        </div>

        <div style="margin-top:1rem;" class="box">
          <h2 style="margin-top:0;">Create / delete review cycle</h2>
          <p class="muted">Cycle ID should be consistent (e.g. <code>2025-360</code>) to avoid variations.</p>
          <div class="row">
            <label class="muted">Cycle ID:</label>
            <input type="text" id="cycle-id" placeholder="2025-360" />

            <label class="muted">Label:</label>
            <input type="text" id="cycle-label" placeholder="2025 Team Leader 360 Review" style="min-width:320px;" />

            <button id="create-cycle-btn">Create cycle</button>
            <button id="delete-cycle-btn" class="danger">Delete selected cycle</button>
          </div>
          <div id="cycle-msg" class="muted" style="margin-top:0.4rem;"></div>
        </div>

        <div style="margin-top:1rem;" class="box">
          <h2 style="margin-top:0;">Team leaders</h2>
          <p class="muted">Manage the list of team leaders used for passcodes and reporting. Names are never shown to reviewers.</p>

          <div id="tl-chips" style="margin-top:0.4rem;"></div>

          <div class="row" style="margin-top:0.7rem;">
            <label class="muted">New / reactivate TL:</label>
            <input type="text" id="new-tl" placeholder="e.g. Gill" />
            <button id="save-tl-btn">Save</button>
          </div>
          <div class="muted" id="tl-msg" style="margin-top:0.4rem;"></div>
        </div>
      </details>

      <hr>
      <p class="muted">Tip: If you’re testing, use “Delete responses (TL in this cycle)” so the overview isn’t skewed.</p>
    </div>
  </div>

  <script>
    const API_BASE = ""; // same origin (Render). For local, also fine.

    let adminKey = null;
    const authHeaders = () => adminKey ? { "x-admin-key": adminKey } : {};

    let radarChart = null;
    let barChart = null;

    let currentCampaignId = null;
    let currentTLId = null;
    let lastDetailData = null;
    let allCampaigns = [];
    let allTLs = [];

    function pillFor(score) {
      if (score == null || isNaN(score)) return { text: "No data", cls: "" };
      if (score >= 4.25) return { text: "Very strong", cls: "good" };
      if (score >= 3.75) return { text: "Strong", cls: "good" };
      if (score >= 3.25) return { text: "Generally positive", cls: "mixed" };
      if (score >= 3.0) return { text: "Mixed", cls: "mixed" };
      return { text: "Needs improvement", cls: "bad" };
    }

    async function attemptLogin() {
      const pwd = document.getElementById("admin-password").value;
      const errEl = document.getElementById("login-error");
      errEl.textContent = "";

      if (!pwd) { errEl.textContent = "Enter the admin password."; return; }
      adminKey = pwd;

      const res = await fetch(API_BASE + "/api/admin/campaigns", { headers: authHeaders() });
      if (!res.ok) {
        adminKey = null;
        errEl.textContent = "Incorrect password or server not configured.";
        return;
      }

      document.getElementById("login-block").style.display = "none";
      document.getElementById("admin-content").style.display = "block";

      await refreshAllLists();
      await loadOverview();
    }

    document.getElementById("login-btn").addEventListener("click", attemptLogin);

    async function refreshAllLists() {
      allCampaigns = await fetchCampaigns();
      allTLs = await fetchTeamLeaders();

      populateCampaignDropdown(document.getElementById("campaign-select"), allCampaigns);
      populateCampaignDropdown(document.getElementById("gen-campaign"), allCampaigns);
      populateCampaignDropdown(document.getElementById("cmp-from"), allCampaigns);
      populateCampaignDropdown(document.getElementById("cmp-to"), allCampaigns);

      populateTLDropdown(document.getElementById("gen-tl"), allTLs.filter(t => t.active));
      renderTLChips(allTLs);
    }

    function populateCampaignDropdown(sel, campaigns) {
      sel.innerHTML = "";
      if (!campaigns || !campaigns.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No cycles yet";
        sel.appendChild(opt);
        return;
      }
      campaigns.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id; // IMPORTANT: campaign id only
        opt.textContent = `${c.label} (${c.id})`;
        sel.appendChild(opt);
      });
    }

    function populateTLDropdown(sel, tls) {
      sel.innerHTML = "";
      if (!tls || !tls.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No active TLs";
        sel.appendChild(opt);
        return;
      }
      tls.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.id;
        sel.appendChild(opt);
      });
    }

    function renderTLChips(tls) {
      const wrap = document.getElementById("tl-chips");
      wrap.innerHTML = "";

      tls.forEach(t => {
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.innerHTML = `
          <strong>${t.id}</strong>
          <span class="muted">${t.active ? "(active)" : "(inactive)"}</span>
        `;

        const btnToggle = document.createElement("button");
        btnToggle.textContent = t.active ? "Deactivate" : "Reactivate";
        btnToggle.addEventListener("click", async () => {
          if (t.active) {
            await deactivateTL(t.id);
          } else {
            await addOrReactivateTL(t.id);
          }
          await refreshAllLists();
        });

        const btnDelete = document.createElement("button");
        btnDelete.textContent = "Delete";
        btnDelete.className = "d";
        btnDelete.addEventListener("click", async () => {
          const ok = confirm(`Delete TL "${t.id}"? This will also delete related codes/feedback via cascade.`);
          if (!ok) return;
          await deleteTL(t.id);
          await refreshAllLists();
        });

        chip.appendChild(btnToggle);
        chip.appendChild(btnDelete);

        wrap.appendChild(chip);
      });
    }

    async function fetchCampaigns() {
      const res = await fetch(API_BASE + "/api/admin/campaigns", { headers: authHeaders() });
      const data = await res.json();
      return data.campaigns || [];
    }

    async function fetchTeamLeaders() {
      const res = await fetch(API_BASE + "/api/admin/team-leaders", { headers: authHeaders() });
      const data = await res.json();
      return data.teamLeaders || [];
    }

    // Create cycle
    async function createCycle() {
      const id = document.getElementById("cycle-id").value.trim();
      const label = document.getElementById("cycle-label").value.trim();
      const msg = document.getElementById("cycle-msg");
      msg.textContent = "";

      if (!id || !label) { msg.textContent = "Provide both an ID and a label."; return; }

      const res = await fetch(API_BASE + "/api/admin/campaigns", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify({ campaignId: id, label })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) { msg.textContent = data.error || "Error creating cycle."; return; }

      msg.textContent = "Cycle saved.";
      await refreshAllLists();
    }

    document.getElementById("create-cycle-btn").addEventListener("click", createCycle);

    async function deleteSelectedCycle() {
      const sel = document.getElementById("campaign-select");
      const campaignId = sel.value;
      const msg = document.getElementById("cycle-msg");
      msg.textContent = "";

      if (!campaignId) { msg.textContent = "Select a cycle first."; return; }
      const ok = confirm(`Delete cycle "${campaignId}"? This deletes codes + feedback in that cycle.`);
      if (!ok) return;

      const res = await fetch(API_BASE + "/api/admin/delete-cycle", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify({ campaignId })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) { msg.textContent = data.error || "Error deleting cycle."; return; }

      msg.textContent = "Cycle deleted.";
      currentCampaignId = null;
      currentTLId = null;
      document.getElementById("detail-block").style.display = "none";
      document.getElementById("detail-intro").style.display = "block";
      await refreshAllLists();
      await loadOverview();
    }

    document.getElementById("delete-cycle-btn").addEventListener("click", deleteSelectedCycle);

    // TL functions
    async function addOrReactivateTL(name) {
      const res = await fetch(API_BASE + "/api/admin/team-leaders", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify({ name })
      });
      return res.ok;
    }

    async function deactivateTL(name) {
      const res = await fetch(API_BASE + "/api/admin/team-leaders/deactivate", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify({ name })
      });
      return res.ok;
    }

    async function deleteTL(name) {
      const res = await fetch(API_BASE + "/api/admin/team-leaders/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify({ name })
      });
      return res.ok;
    }

    document.getElementById("save-tl-btn").addEventListener("click", async () => {
      const name = document.getElementById("new-tl").value.trim();
      const msg = document.getElementById("tl-msg");
      msg.textContent = "";
      if (!name) { msg.textContent = "Enter a name."; return; }
      await addOrReactivateTL(name);
      document.getElementById("new-tl").value = "";
      msg.textContent = "Saved.";
      await refreshAllLists();
    });

    // Overview
    async function loadOverview() {
      const campaignId = document.getElementById("campaign-select").value;
      const status = document.getElementById("cycle-status");
      status.textContent = "";

      if (!campaignId) {
        status.textContent = "No cycle selected.";
        return;
      }
      currentCampaignId = campaignId;

      const res = await fetch(
        API_BASE + `/api/admin/overview?campaignId=${encodeURIComponent(campaignId)}`,
        { headers: authHeaders() }
      );
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        status.textContent = data.error || "Error loading overview.";
        return;
      }

      const tbody = document.querySelector("#overview-table tbody");
      tbody.innerHTML = "";

      (data.results || []).forEach(row => {
        const tr = document.createElement("tr");
        tr.dataset.tl = row.teamLeaderId;
        const p = pillFor(row.avgScore);

        tr.innerHTML = `
          <td>${row.teamLeaderId}</td>
          <td>${row.responseCount}</td>
          <td>${row.responseCount ? row.avgScore.toFixed(2) : "-"}</td>
          <td><span class="pill ${p.cls}">${p.text}</span></td>
        `;

        tr.addEventListener("click", () => loadDetail(campaignId, row.teamLeaderId));
        tbody.appendChild(tr);
      });

      // keep compare dropdowns synced
      populateCampaignDropdown(document.getElementById("cmp-from"), allCampaigns);
      populateCampaignDropdown(document.getElementById("cmp-to"), allCampaigns);
    }

    document.getElementById("refresh-overview").addEventListener("click", loadOverview);

    async function loadDetail(campaignId, teamLeaderId) {
      currentCampaignId = campaignId;
      currentTLId = teamLeaderId;

      const res = await fetch(
        API_BASE + `/api/admin/detail?campaignId=${encodeURIComponent(campaignId)}&teamLeaderId=${encodeURIComponent(teamLeaderId)}`,
        { headers: authHeaders() }
      );
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        alert(data.error || "Error loading detail.");
        return;
      }

      lastDetailData = data;

      document.getElementById("detail-intro").style.display = "none";
      document.getElementById("detail-block").style.display = "block";

      document.getElementById("detail-title").textContent =
        `${teamLeaderId} – ${data.responseCount} responses, overall avg ${data.avgOverall ? Number(data.avgOverall).toFixed(2) : "-"}`;

      // Summary text
      const catEntries = Object.entries(data.categoryAverages || {}).filter(([_, v]) => v != null);
      catEntries.sort((a,b) => (b[1]||0) - (a[1]||0));
      const strongest = catEntries[0];
      const weakest = catEntries[catEntries.length - 1];

      let summary = data.responseCount
        ? `Based on ${data.responseCount} anonymous responses, the overall average score is ${data.avgOverall ? Number(data.avgOverall).toFixed(2) : "-"} out of 5.`
        : "No feedback submitted yet for this team leader in this cycle.";

      if (strongest && strongest[1] >= 3.75) summary += ` ${strongest[0]} is a clear strength.`;
      if (weakest && weakest[1] < 3.5 && (!strongest || weakest[0] !== strongest[0])) summary += ` ${weakest[0]} shows the greatest opportunity for development.`;

      document.getElementById("detail-summary-text").textContent = summary;

      // Action areas
      const aa = document.getElementById("action-areas");
      if (!data.actionAreas || !data.actionAreas.length) {
        aa.textContent = "Not enough data yet.";
      } else {
        aa.innerHTML = data.actionAreas.map(x =>
          `• ${x.category}: ${Number(x.avg).toFixed(2)} (${x.interpretation})`
        ).join("<br>");
      }

      // Category table
      const tbody = document.querySelector("#category-table tbody");
      tbody.innerHTML = "";
      for (const [cat, avg] of Object.entries(data.categoryAverages || {})) {
        const p = pillFor(avg);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${cat}</td>
          <td>${avg != null ? Number(avg).toFixed(2) : "-"}</td>
          <td><span class="pill ${p.cls}">${p.text}</span></td>
        `;
        tbody.appendChild(tr);
      }

      // Comments
      const commentsDiv = document.getElementById("comments-section");
      commentsDiv.innerHTML = "";
      if (!data.comments) {
        commentsDiv.innerHTML = `<p class="muted">Comments hidden until 3+ responses to protect anonymity.</p>`;
      } else {
        const { strengths, devs, others } = data.comments;

        if (strengths.length) {
          commentsDiv.innerHTML += "<h4>Strengths (raw comments)</h4>";
          strengths.forEach(c => {
            const div = document.createElement("div");
            div.className = "comment-block";
            div.textContent = c;
            commentsDiv.appendChild(div);
          });
        }
        if (devs.length) {
          commentsDiv.innerHTML += "<h4>Development areas (raw comments)</h4>";
          devs.forEach(c => {
            const div = document.createElement("div");
            div.className = "comment-block";
            div.textContent = c;
            commentsDiv.appendChild(div);
          });
        }
        if (others.length) {
          commentsDiv.innerHTML += "<h4>Other comments</h4>";
          others.forEach(c => {
            const div = document.createElement("div");
            div.className = "comment-block";
            div.textContent = c;
            commentsDiv.appendChild(div);
          });
        }
      }

      document.getElementById("ai-summary-text").textContent = "";
      document.getElementById("cmp-out").textContent = "";

      drawCharts(data.categoryAverages || {}, data.questionAverages || {});

      // Default compare selects: from previous cycle if exists
      const fromSel = document.getElementById("cmp-from");
      const toSel = document.getElementById("cmp-to");
      toSel.value = campaignId;
      if (allCampaigns.length >= 2) {
        const idx = allCampaigns.findIndex(c => c.id === campaignId);
        const prev = allCampaigns[idx + 1] || allCampaigns[1] || allCampaigns[0];
        if (prev && prev.id) fromSel.value = prev.id;
      }
    }

    function drawCharts(catScores, questionAverages) {
      const radarCtx = document.getElementById("radarChart").getContext("2d");
      const barCtx = document.getElementById("barChart").getContext("2d");

      const catLabels = Object.keys(catScores);
      const catValues = catLabels.map(k => catScores[k] || 0);

      if (radarChart) radarChart.destroy();
      radarChart = new Chart(radarCtx, {
        type: "radar",
        data: {
          labels: catLabels,
          datasets: [{ label: "Category average", data: catValues }]
        },
        options: { scales: { r: { suggestedMin: 1, suggestedMax: 5 } } }
      });

      const qLabels = Object.keys(questionAverages).sort();
      const qValues = qLabels.map(k => questionAverages[k] || 0);

      if (barChart) barChart.destroy();
      barChart = new Chart(barCtx, {
        type: "bar",
        data: {
          labels: qLabels,
          datasets: [{ label: "Question avg", data: qValues }]
        },
        options: { scales: { y: { suggestedMin: 1, suggestedMax: 5 } } }
      });
    }

    // AI summary
    document.getElementById("ai-summary-btn").addEventListener("click", async () => {
      const el = document.getElementById("ai-summary-text");
      if (!currentCampaignId || !currentTLId) { el.textContent = "Select a team leader first."; return; }
      el.textContent = "Generating AI summary...";
      const res = await fetch(
        API_BASE + `/api/admin/ai-summary?campaignId=${encodeURIComponent(currentCampaignId)}&teamLeaderId=${encodeURIComponent(currentTLId)}`,
        { headers: authHeaders() }
      );
      const data = await res.json().catch(() => ({}));
      if (!res.ok) { el.textContent = data.error || "Error generating AI summary."; return; }
      el.textContent = data.summary || "(No summary)";
    });

    // Delete responses
    document.getElementById("delete-responses-btn").addEventListener("click", async () => {
      if (!currentCampaignId || !currentTLId) return;
      const ok = confirm(`Delete ALL responses for ${currentTLId} in cycle ${currentCampaignId}? This cannot be undone.`);
      if (!ok) return;

      const res = await fetch(API_BASE + "/api/admin/delete-feedback", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify({ campaignId: currentCampaignId, teamLeaderId: currentTLId })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) { alert(data.error || "Error deleting feedback."); return; }
      alert(`Deleted ${data.deletedRows || 0} responses.`);
      await loadOverview();
      document.getElementById("detail-block").style.display = "none";
      document.getElementById("detail-intro").style.display = "block";
    });

    // Generate codes
    document.getElementById("gen-btn").addEventListener("click", async () => {
      const campaignId = document.getElementById("gen-campaign").value;
      const teamLeaderId = document.getElementById("gen-tl").value;
      const count = Number(document.getElementById("gen-count").value);
      const out = document.getElementById("gen-output");
      out.textContent = "";

      if (!campaignId || !teamLeaderId || !count) { out.textContent = "Fill all fields."; return; }

      const res = await fetch(API_BASE + "/api/admin/generate-codes", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: JSON.stringify({ campaignId, teamLeaderId, count })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) { out.textContent = data.error || "Error generating codes."; return; }
      out.textContent = (data.codes || []).join("\n");
    });

    // Compare cycles
    document.getElementById("cmp-btn").addEventListener("click", async () => {
      const out = document.getElementById("cmp-out");
      out.textContent = "";
      if (!currentTLId) { out.textContent = "Select a team leader first."; return; }

      const fromCycle = document.getElementById("cmp-from").value;
      const toCycle = document.getElementById("cmp-to").value;
      const includeAi = document.getElementById("cmp-ai").checked ? "1" : "0";

      if (!fromCycle || !toCycle) { out.textContent = "Pick two cycles."; return; }
      if (fromCycle === toCycle) { out.textContent = "Pick two different cycles."; return; }

      out.textContent = "Comparing...";
      const res = await fetch(
        API_BASE + `/api/admin/compare?teamLeaderId=${encodeURIComponent(currentTLId)}&fromCycle=${encodeURIComponent(fromCycle)}&toCycle=${encodeURIComponent(toCycle)}&includeAi=${includeAi}`,
        { headers: authHeaders() }
      );
      const data = await res.json().catch(() => ({}));
      if (!res.ok) { out.textContent = data.error || "Compare failed."; return; }

      const od = data.overallDelta;
      const overallLine = (od == null) ? "Overall: n/a" : `Overall change: ${od >= 0 ? "+" : ""}${od.toFixed(2)}`;

      const deltas = data.deltas || {};
      const lines = [];
      for (const [cat, d] of Object.entries(deltas)) {
        if (d == null) continue;
        lines.push(`${cat}: ${d >= 0 ? "+" : ""}${d.toFixed(2)}`);
      }

      let txt = `${overallLine}\n\nCategory changes:\n${lines.length ? lines.map(l => "• " + l).join("\n") : "n/a"}`;

      if (data.aiChangeSummary) {
        txt += `\n\nAI change summary:\n${data.aiChangeSummary}`;
      }

      out.textContent = txt;
    });

    // PDF
    document.getElementById("pdf-btn").addEventListener("click", async () => {
      if (!lastDetailData || !currentTLId || !currentCampaignId) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const title = `360° Feedback – ${currentTLId}`;
      doc.setFontSize(16);
      doc.text(title, 10, 15);

      doc.setFontSize(11);
      doc.text(`Cycle: ${currentCampaignId}`, 10, 25);
      doc.text(`Responses: ${lastDetailData.responseCount}`, 10, 31);
      doc.text(`Overall average: ${lastDetailData.avgOverall ? Number(lastDetailData.avgOverall).toFixed(2) : "-"}`, 10, 37);

      doc.setFontSize(11);
      doc.text("Summary:", 10, 47);
      doc.setFontSize(10);
      const summary = document.getElementById("detail-summary-text").textContent || "";
      doc.text(doc.splitTextToSize(summary, 180), 10, 53);

      const aiSummary = document.getElementById("ai-summary-text").textContent || "";
      if (aiSummary && !aiSummary.startsWith("Generating")) {
        doc.setFontSize(11);
        doc.text("AI themes from comments:", 10, 85);
        doc.setFontSize(10);
        doc.text(doc.splitTextToSize(aiSummary, 180), 10, 91);
      }

      doc.save(`TL360-${currentCampaignId}-${currentTLId}.pdf`);
    });
  </script>
</body>
</html>
